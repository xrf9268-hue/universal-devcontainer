# Optimized pre-built image for Universal Dev Container
# This Dockerfile is optimized for layer caching and pre-built image distribution
# Build: docker build -t ghcr.io/xrf9268-hue/universal-devcontainer:latest .
# Push: docker push ghcr.io/xrf9268-hue/universal-devcontainer:latest

# Pin to specific version tag (1-ubuntu-22.04) for reproducibility
# To pin by SHA, run: docker pull mcr.microsoft.com/devcontainers/base:1-ubuntu-22.04 && docker inspect --format='{{index .RepoDigests 0}}' mcr.microsoft.com/devcontainers/base:1-ubuntu-22.04
FROM mcr.microsoft.com/devcontainers/base:1-ubuntu-22.04

# Metadata
LABEL org.opencontainers.image.source="https://github.com/xrf9268-hue/universal-devcontainer"
LABEL org.opencontainers.image.description="Universal Dev Container with Claude Code, firewall, and proxy support"
LABEL org.opencontainers.image.licenses="MIT"

# Accept build arguments (optional for pre-built image)
ARG TZ=UTC
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG NO_PROXY

# Set build-time proxy environment (if provided)
ENV http_proxy=${HTTP_PROXY} \
    https_proxy=${HTTPS_PROXY} \
    HTTP_PROXY=${HTTP_PROXY} \
    HTTPS_PROXY=${HTTPS_PROXY} \
    NO_PROXY=${NO_PROXY} \
    no_proxy=${NO_PROXY}

# Configure APT proxy if needed
RUN if [ -n "${HTTP_PROXY}" ]; then \
      echo "Acquire::http::Proxy \"${HTTP_PROXY}\";" > /etc/apt/apt.conf.d/99proxy && \
      echo "Acquire::https::Proxy \"${HTTPS_PROXY}\";" >> /etc/apt/apt.conf.d/99proxy; \
    fi

# Layer 1: Install system packages (changes infrequently)
# Ordered by change frequency: least frequently changed first
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      # Essential tools
      ca-certificates \
      curl \
      wget \
      git \
      # Firewall and networking
      iptables \
      dnsutils \
      netcat-traditional \
      # Utilities
      jq \
      unzip \
      zip \
      # Shell
      zsh \
      sudo && \
    # Clean up APT cache to reduce image size
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Layer 2: Create workspace directory (rarely changes)
RUN mkdir -p /workspace /universal && \
    chown -R vscode:vscode /workspace

# Layer 3: Configure shell banner (rarely changes)
COPY --chown=root:root <<'EOF' /usr/local/bin/devcontainer-banner.sh
#!/usr/bin/env bash
set -euo pipefail

# Only for interactive shells
if [ -z "${PS1:-}" ]; then exit 0; fi

PROJECT="${PROJECT_PATH:-}"
WS="/workspace"
UNI="/universal"

is_mounted() {
  grep -qE " $1 " /proc/mounts 2>/dev/null
}

status_ws="absent"
if [ -d "$WS" ]; then
  if is_mounted "$WS"; then status_ws="mounted"; else status_ws="dir-only"; fi
fi

status_uni="missing"
if is_mounted "$UNI"; then status_uni="mounted"; else status_uni="missing"; fi

cat <<EOT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Dev Container — Workspace status
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 PROJECT_PATH: ${PROJECT:-<not set>}
 /workspace:   ${status_ws}
 /universal:   ${status_uni}
 Tip: set PROJECT_PATH via scripts/open-project.sh or dev.containers.defaultEnv
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
EOT
EOF

RUN chmod +x /usr/local/bin/devcontainer-banner.sh

# Layer 4: Configure shell integrations (rarely changes)
RUN echo '\n# devcontainer banner (interactive shells)\nif [ -n "$PS1" ]; then /usr/local/bin/devcontainer-banner.sh 2>/dev/null || true; fi' >> /etc/bash.bashrc && \
    if [ -d /etc/zsh ]; then \
      echo '\n# devcontainer banner (interactive shells)\nif [ -n "$PS1" ]; then /usr/local/bin/devcontainer-banner.sh 2>/dev/null || true; fi' >> /etc/zsh/zshrc; \
    fi

# Layer 5: Configure persistent shell history (rarely changes)
RUN if [ -d /etc/zsh ]; then \
      printf '\n# Persist history to /commandhistory (devcontainer volume)\nexport HISTFILE=/commandhistory/.zsh_history\nexport HISTSIZE=100000\nexport SAVEHIST=100000\n' >> /etc/zsh/zshrc; \
    fi && \
    printf '\n# Persist bash history to /commandhistory (devcontainer volume)\nexport HISTFILE=/commandhistory/.bash_history\nexport HISTSIZE=100000\nexport HISTCONTROL=ignoredups:erasedups\nshopt -s histappend\nPROMPT_COMMAND="history -a; $PROMPT_COMMAND"\n' >> /etc/bash.bashrc

# Layer 6: Set default timezone (can be overridden at runtime)
ENV TZ=${TZ}
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Clean up proxy configuration (not needed at runtime)
RUN rm -f /etc/apt/apt.conf.d/99proxy

# Set default user
USER vscode

# Default command
CMD ["/bin/bash"]

# Build metadata
ARG BUILD_DATE
ARG VERSION=2.1.0
LABEL org.opencontainers.image.created="${BUILD_DATE}"
LABEL org.opencontainers.image.version="${VERSION}"
